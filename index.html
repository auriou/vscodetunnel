<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <meta name="theme-color" content="#0b0b0f" media="(prefers-color-scheme: dark)" />
  <title>CodeTunnel</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CodeTunnel" />
  
  <!-- Android Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <style>
    :root { color-scheme: dark; }
    /* Espace dynamique si window-controls-overlay actif (Windows PWA) */
    :root { --titlebar-height: env(titlebar-area-height, 0px); }
    body.wco { padding-top: var(--titlebar-height); }
    body.wco header { position: fixed; left:0; right:0; top:0; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif; background: #0b0b0f; color: #e6e6ea; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    header { flex-shrink: 0; display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; border-bottom: 1px solid #1b1b22; background: #0b0b0f; min-height:48px; z-index:100; }
    h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: .3px; display:flex; align-items:center; gap:8px; }
    main { flex: 1; overflow-y: auto; overflow-x: hidden; max-width: 900px; margin: 0 auto; padding: 20px 16px 40px; width: 100%; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    button, input, select, textarea { font: inherit; background: #14141c; color: #fff; border: 1px solid #2a2a35; border-radius: 10px; padding: 8px 12px; font-size: 14px; }
    button { display:inline-flex; align-items:center; gap:6px; white-space:nowrap; }
    button svg { width:16px; height:16px; flex-shrink:0; }
    button { background: #2563eb; border-color: #2563eb; cursor: pointer; }
    button.ghost { background: #14141c; border-color:#2a2a35; }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
    .card { padding: 16px; border-radius: 14px; background: #111118; border: 1px solid #1c1c27; display:flex; flex-direction:column; gap: 12px; }
    .card h3 { margin: 0; font-size: 17px; font-weight: 600; }
    .muted { color: #9aa0a6; font-size: 13px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .row button { font-size: 13px; padding: 7px 10px; }
    @media (max-width: 640px) { 
      header { flex-direction: column; gap: 10px; align-items: stretch; }
      .actions { justify-content: center; }
      button { flex: 1; min-width: 0; justify-content: center; }
    }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 12px; color:#aab; }
    .danger { color:#ff6b6b; border-color:#ff6b6b !important; background:#281a1a !important; }
    dialog { background:#0f0f16; color:#fff; border:1px solid #242433; border-radius:16px; padding:16px; max-width:680px; width:calc(100% - 24px); }
    dialog::backdrop { background: rgba(0,0,0,.5); }
    .footer { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px; }
    .hint { font-size:12px; color:#9aa0a6; }
    .empty { padding: 40px 10px; text-align: center; border:1px dashed #26263a; border-radius:16px; }
    a.link { color:#8ab4ff; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <h1>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      CodeTunnel <span class="muted" style="font-weight:400; font-size:11px;">v1.0.3</span>
    </h1>
    <div class="actions">
      <button class="ghost" id="btnExport">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export
      </button>
      <button id="btnImport" class="ghost">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Import
      </button>
      <input type="file" id="importFile" accept="application/json" hidden />
      <button id="btnAdd">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        Nouveau
      </button>
    </div>
  </header>

  <main>
    <div id="list"></div>
  </main>

  <dialog id="dlg">
    <form id="form" method="dialog">
      <h3 id="dlgTitle">Nouveau projet</h3>
      <div class="grid" style="margin-top:8px">
        <div class="field">
          <label for="name">Nom de l’application</label>
          <input id="name" placeholder="Ex. My Project" required />
        </div>
        <div class="field">
          <label for="tunnel">Nom du tunnel</label>
          <input id="tunnel" placeholder="Ex. my-tunnel" required />
        </div>
        <div class="field" style="grid-column: 1 / -1">
          <label for="path">Dossier à ouvrir</label>
          <input id="path" placeholder="Ex. d:/user/myproject" required />
        </div>
        <div class="field">
          <label for="lang">Langue (facultatif)</label>
          <select id="lang">
            <option value="">Par défaut</option>
            <option value="fr-fr">fr-fr</option>
            <option value="en">en</option>
          </select>
        </div>
      </div>
      <div class="footer">
        <span class="hint">Rien n’est envoyé en ligne — tout est stocké dans <b>localStorage</b>.</span>
        <div class="row">
          <button class="ghost" value="cancel">Annuler</button>
          <button id="btnSave" value="default">Enregistrer</button>
        </div>
      </div>
      <input type="hidden" id="editId" />
    </form>
  </dialog>

  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js', { scope: './' }); }

    const KEY = 'vscode_tunnel_projects_v1';
    const $ = (q, root=document) => root.querySelector(q);
    function load() { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
    function save(items) { localStorage.setItem(KEY, JSON.stringify(items)); render(); }
    function buildUrl(p) {
      const cleanPath = p.path.trim().replace(/\\/g,'/');
      const base = `https://vscode.dev/tunnel/${encodeURIComponent(p.tunnel)}/${cleanPath}`;
      const params = new URLSearchParams();
      if (p.lang) params.set('vscode-lang', p.lang);
      return base + (params.size ? '?' + params.toString() : '');
    }
    function escapeHtml(s) { return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function render() {
      const items = load();
      const root = $('#list');
      if (!items.length) {
        root.innerHTML = `<div class="empty">
          <p>Aucun projet configuré.</p>
          <p><button id="addFirst">Créer un projet</button></p>
        </div>`;
        $('#addFirst').onclick = () => $('#btnAdd').click();
        return;
      }
      root.innerHTML = '<div class="grid"></div>';
      const grid = root.querySelector('.grid');
      items.forEach((p, idx) => {
        const url = buildUrl(p);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${escapeHtml(p.name)}</h3>
          <div class="muted">Tunnel: <b>${escapeHtml(p.tunnel)}</b></div>
          <div class="muted">Dossier: <code>${escapeHtml(p.path)}</code></div>
          <div class="row">
            <button data-act="open">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              Ouvrir
            </button>
            <button class="ghost" data-act="open-pwa">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
              PWA
            </button>
            <button class="ghost" data-act="edit">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              Éditer
            </button>
            <button class="ghost danger" data-act="del">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Suppr
            </button>
          </div>
          <div class="hint" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Lien: <a class="link" href="${url}">${url}</a></div>
        `;
        card.onclick = (e) => {
          const act = e.target.closest('button')?.getAttribute('data-act');
          if (!act) return;
          if (act === 'open') openTunnel(url);
          if (act === 'open-pwa') openTunnelInPwa(url);
          if (act === 'edit') edit(idx);
          if (act === 'del') del(idx);
        };
        grid.appendChild(card);
      });
    }
    function openTunnel(url) {
      window.location.replace(url);
    }
    function openTunnelInPwa(url) {
      window.open(url, '_blank', 'noopener');
    }

    function edit(i) {
      const p = load()[i];
      $('#editId').value = i;
      $('#name').value = p.name;
      $('#tunnel').value = p.tunnel;
      $('#path').value = p.path;
      $('#lang').value = p.lang || "";
      $('#dlgTitle').textContent = 'Modifier le projet';
      $('#dlg').showModal();
    }
    function del(i) {
      const items = load();
      if (!confirm(`Supprimer « ${items[i].name} » ?`)) return;
      items.splice(i,1); save(items);
    }

    $('#btnAdd').onclick = () => { $('#editId').value=''; $('#form').reset(); $('#dlgTitle').textContent='Nouveau projet'; $('#dlg').showModal(); };
    $('#btnSave').onclick = (e) => {
      e.preventDefault();
      const name = $('#name').value.trim();
      const tunnel = $('#tunnel').value.trim();
      const path = $('#path').value.trim();
      const lang = $('#lang').value;
      if (!name || !tunnel || !path) return;
      const items = load();
      const id = $('#editId').value;
      const proj = { name, tunnel, path, lang };
      if (id === '') items.push(proj); else items[+id] = proj; save(items);
      $('#dlg').close();
    };
    $('#btnExport').onclick = () => {
      const blob = new Blob([JSON.stringify(load(), null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'vscode-tunnels-projects.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    $('#btnImport').onclick = () => document.getElementById('importFile').click();
    document.getElementById('importFile').onchange = async (e) => {
      const f = e.target.files[0]; if (!f) return;
      try { const items = JSON.parse(await f.text()); if (Array.isArray(items)) save(items); } catch { alert('Fichier invalide'); }
      e.target.value = '';
    };

    // Window Controls Overlay support
    if (navigator.windowControlsOverlay) {
      document.body.classList.add('wco');
      const applyGeom = () => {
        const r = navigator.windowControlsOverlay.getTitlebarAreaRect();
        document.documentElement.style.setProperty('--titlebar-height', r.height + 'px');
      };
      navigator.windowControlsOverlay.addEventListener('geometrychange', applyGeom);
      applyGeom();
    }

    // Détection potentielle de la PWA vscode.dev (expérimental / peut ne rien retourner)
    const HINT_ID = 'vsHint';
    function showHint(text) {
      let hint = document.getElementById(HINT_ID);
      if (!hint) {
        hint = document.createElement('div');
        hint.id = HINT_ID;
        hint.className = 'hint';
        document.querySelector('main').prepend(hint);
      }
      hint.textContent = text;
    }

    async function detectVsCodePwa() {
      if (!('getInstalledRelatedApps' in navigator)) {
        showHint("Astuce: installez aussi vscode.dev comme PWA (menu navigateur) pour un lancement plus immersif.");
        return;
      }
      try {
        const apps = await navigator.getInstalledRelatedApps();
        const found = apps.some(a => (a.url || '').includes('vscode.dev'));
        showHint(found
          ? "VS Code PWA détectée: utilisez le bouton 'PWA' pour ouvrir directement."
          : "VS Code PWA non détectée. Ouvrez https://vscode.dev puis 'Installer l'application'.");
      } catch {
        showHint("Détection VS Code PWA indisponible. Vous pouvez l'installer via https://vscode.dev.");
      }
    }

    detectVsCodePwa();
    render();
  </script>
</body>
</html>
